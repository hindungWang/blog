<!DOCTYPE html>
<html lang="en">
<head>
  
    <title>Golang-interface的底层原理浅析 :: Hindung Blogs</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Golang-interface的一些浅显的看法" />
<meta name="keywords" content="" />
<meta name="robots" content="noodp" />
<link rel="canonical" href="http://hindung.cn/posts/1/" />




<link rel="stylesheet" href="http://hindung.cn/assets/style.css">

  <link rel="stylesheet" href="http://hindung.cn/assets/green.css">






<link rel="apple-touch-icon" href="http://hindung.cn/img/apple-touch-icon-192x192.png">

  <link rel="shortcut icon" href="http://hindung.cn/img/favicon/green.png">



<meta name="twitter:card" content="summary" />



<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Golang-interface的底层原理浅析">
<meta property="og:description" content="Golang-interface的一些浅显的看法" />
<meta property="og:url" content="http://hindung.cn/posts/1/" />
<meta property="og:site_name" content="Hindung Blogs" />

  
    <meta property="og:image" content="http://hindung.cn/img/favicon/green.png">
  

<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">


  <meta property="article:published_time" content="2020-07-23 00:00:00 &#43;0000 UTC" />












</head>
<body class="green">


<div class="container center headings--one-size">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="/">
  <div class="logo">
    Hindung
  </div>
</a>

    </div>
    
      <div class="menu-trigger">menu</div>
    
  </div>
  
    <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about">About</a></li>
        
      
        
          <li><a href="/posts">Post</a></li>
        
      
      
    

    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about">About</a></li>
      
    
      
        <li><a href="/posts">Post</a></li>
      
    
    
  </ul>
</nav>

  
</header>


  <div class="content">
    
<div class="post">
  <h1 class="post-title">
    <a href="http://hindung.cn/posts/1/">Golang-interface的底层原理浅析</a></h1>
  <div class="post-meta">
    
      <span class="post-date">
        2020-07-23
        
      </span>
    
    
    
      <span class="post-reading-time">:: 5 min read (971 words)</span>
    
  </div>

  
  <span class="post-tags">
    
    #<a href="http://hindung.cn/tags/go/">Go</a>&nbsp;
    
  </span>
  
  


  
    <div class="table-of-contents">
      <h2>
        Table of Contents
      </h2>
      <nav id="TableOfContents">
  <ul>
    <li><a href="#前言">前言</a></li>
    <li><a href="#interface定义">Interface定义</a></li>
    <li><a href="#空interface">空interface</a></li>
    <li><a href="#类型断言">类型断言</a></li>
    <li><a href="#interface的实现">Interface的实现</a></li>
    <li><a href="#interface的构造过程">Interface的构造过程</a></li>
    <li><a href="#总结">总结</a></li>
  </ul>
</nav>
    </div>
  

  <div class="post-content"><div>
        <h2 id="前言">前言<a href="#前言" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p><code>Go</code>语言在语法上相对<code>C/C++</code>来说，是比较简单的，基本语法多刷刷题目，然后工程的架构、目录规则等多看看其他开源项目，就应该能比较熟悉了。<code>Go</code>语言比较核心的设计 包括<code>interface</code>、内存模型、<code>defer</code>机制、<code>goroutine</code>实现与调度、<code>cgo</code>、数组与切片、<code>Go</code>编译器和连接器、<code>GC</code>实现这几大块。</p>
<p><strong>注：所有源码基于 go version go1.13.5 windows/amd64</strong></p>
<p>本篇笔记目的是了解<code>interface</code>的特性，并知道如何用好它。</p>
<h2 id="interface定义">Interface定义<a href="#interface定义" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<ul>
<li>是一种类型</li>
<li>可以定义0个或多个方法（一组行为）</li>
<li>可以嵌入其他接口（目标类型方法集中必须拥有包含嵌入接口方法在内的全部方法才算实现了该接口）</li>
</ul>
<p>如：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Notifier</span> <span style="color:#66d9ef">interface</span> {
</span></span><span style="display:flex;"><span>　 <span style="color:#a6e22e">notify</span>()
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>这就定义了一个名为<code>Notifier</code>的<code>interface</code>，实现这个<code>interface</code>很简单，实现<code>notify</code>方法即可：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">User</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>　 <span style="color:#a6e22e">name</span>　<span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">u</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">User</span>) <span style="color:#a6e22e">notify</span>() {
</span></span><span style="display:flex;"><span>　 <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;Notify user name %s\n&#34;</span>, <span style="color:#a6e22e">u</span>.<span style="color:#a6e22e">name</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>其他结构体也可以实现这个<code>interface</code>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Admin</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>　 <span style="color:#a6e22e">name</span>　<span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">a</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Admin</span>) <span style="color:#a6e22e">notify</span>() {
</span></span><span style="display:flex;"><span>　 <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;Sending admin name %s\n&#34;</span>, <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">name</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>这种实现是<code>DuckType</code>：类型不需要显式声明它实现了某个接口：接口被隐式地实现。多个类型可以实现同一个接。</p>
<p>在调用<code>notify</code>的地方实现如下方法，即可实现多态性，即面向接口编程：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">sendNotify</span>(<span style="color:#a6e22e">n</span> <span style="color:#a6e22e">Notifier</span>) {
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">n</span>.<span style="color:#a6e22e">notify</span>()
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>函数<code>sendNotify</code>接受一个实现了<code>Notifier</code>接口的值作为参数。 既然任意一个实体类型都能实现该接口，那么这个函数可以针对任意实体类型的值来执行notify方法，调用<code>notify</code>时， 会根据对象的实际定义来实现不同的行为，从而实现多态行为。</p>
<p>这里需要注意的地方是，<code>Notifier</code>接口只有一个方法，并且<code>*Admin</code> 和 <code>*User</code>类型都实现了<code>notify</code>方法，这就说明<code>*Admin</code>和<code>*User</code>类型实现了<code>Notifier</code>接口。如果<code>Notifier</code>有多个方法时，情况可能就会不一样：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Person</span> <span style="color:#66d9ef">interface</span> {   
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">job</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">growUp</span>()
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Student</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">age</span> <span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#a6e22e">Student</span>) <span style="color:#a6e22e">job</span>() {              <span style="color:#75715e">// Student类型实现了job方法
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;I am a student.&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Student</span>) <span style="color:#a6e22e">growUp</span>() {          <span style="color:#75715e">// *Student类型实现了growUp方法（注意这里的区别）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">age</span> <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Programmer</span> <span style="color:#66d9ef">struct</span> {              
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">age</span> <span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#a6e22e">Programmer</span>) <span style="color:#a6e22e">job</span>() {           <span style="color:#75715e">// Programmer类型实现了job方法
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;I am a programmer.&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#a6e22e">Programmer</span>) <span style="color:#a6e22e">growUp</span>() {        <span style="color:#75715e">// Programmer类型实现了growUp方法
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">age</span> <span style="color:#f92672">+=</span> <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>*Student</code>和<code>Programmer</code>类型实现了<code>Person</code>接口，但是<code>Student</code>类型却没用，因为<code>Student</code>类型没有实现<code>Person</code>接口，执行以下程序时就会报错：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">s</span> <span style="color:#a6e22e">Person</span> = <span style="color:#a6e22e">Student</span>{<span style="color:#ae81ff">9</span>} <span style="color:#75715e">// 报错
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">job</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">growUp</span>()   
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 改成如下会成功
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">s</span> <span style="color:#a6e22e">Person</span> = <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Student</span>{<span style="color:#ae81ff">9</span>}
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">job</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">growUp</span>()  
</span></span></code></pre></div><p><code>*Student</code>类型为什么会实现了<code>Person</code>接口呢？是因为<code>Student</code>类型实现了<code>job</code>方法，所以让 <code>*Student</code>类型自动拥有了<code>job</code>方法。也就是：实现了接收者是值类型的方法，相当于自动实现了接收者是指针类型的方法；而实现了接收者是指针类型的方法，不会自动生成对应接收者是值类型的方法。</p>
<h2 id="空interface">空interface<a href="#空interface" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>在<code>Go</code>中，有种空的<code>interface</code>类型，即没有任何方法的<code>interface</code>：<code>interface{}</code>。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Any</span> <span style="color:#66d9ef">interface</span> {}
</span></span></code></pre></div><p>对空接口类型来说，我们可以将任意一种类型的值赋值给空接口类型（就好比<code>java</code>的最高级父类）：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">any</span> <span style="color:#66d9ef">interface</span> {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">any</span> = <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">any</span> = <span style="color:#ae81ff">14.5</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">any</span> = <span style="color:#e6db74">&#34;hello&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span></code></pre></div><h2 id="类型断言">类型断言<a href="#类型断言" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>在上面的多态函数的实现中，我们如何去判断传进来的<code>n</code>是<code>User</code>还是<code>Admin</code>呢？使用类型断言可以解决：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">sendNotify</span>(<span style="color:#a6e22e">n</span> <span style="color:#a6e22e">Notifier</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">n</span>.<span style="color:#a6e22e">notify</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">v</span><span style="color:#f92672">:=</span> <span style="color:#a6e22e">n</span>.(<span style="color:#66d9ef">type</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">User</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//is User role
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">case</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Admin</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//is Admin role
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">default</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;don&#39;t know the type&#34;</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="interface的实现">Interface的实现<a href="#interface的实现" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>任何<code>interface</code>类型，在内存中都是2个字长，32位机器上是8<code>Byte</code>，64位机器上是16<code>Byte</code>。</p>
<p>空<code>interface</code>的源码(src\runtime\runtime2.go line 197左右)：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">eface</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">_type</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">_type</span>          <span style="color:#75715e">// 类型指针
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">data</span>  <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>  <span style="color:#75715e">// 数据区域指针
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><p>里面就两个指针，<code>_type</code>类型表示了类型的基本信息，类型大小，对齐信息，类型编号等，源码如下(src\runtime\type.go line 28左右)：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">_type</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">size</span>       <span style="color:#66d9ef">uintptr</span>   <span style="color:#75715e">// 类型大小
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">ptrdata</span>    <span style="color:#66d9ef">uintptr</span>   <span style="color:#75715e">// size of memory prefix holding all pointers
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">hash</span>       <span style="color:#66d9ef">uint32</span>    <span style="color:#75715e">// 哈希值
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">tflag</span>      <span style="color:#a6e22e">tflag</span>     <span style="color:#75715e">// 类型的flag，与反射相关
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">align</span>      <span style="color:#66d9ef">uint8</span>     <span style="color:#75715e">// 内存对齐相关
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">fieldalign</span> <span style="color:#66d9ef">uint8</span>     <span style="color:#75715e">// 内存对齐相关
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">kind</span>       <span style="color:#66d9ef">uint8</span>     <span style="color:#75715e">// 类型的编号
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">alg</span>        <span style="color:#f92672">*</span><span style="color:#a6e22e">typeAlg</span>  <span style="color:#75715e">// 类型的编号相关
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// gcdata stores the GC type data for the garbage collector.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// If the KindGCProg bit is set in kind, gcdata is a GC program.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// Otherwise it is a ptrmask bitmap. See mbitmap.go for details.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">gcdata</span>    <span style="color:#f92672">*</span><span style="color:#66d9ef">byte</span>      <span style="color:#75715e">// 以下就是gc相关
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">str</span>       <span style="color:#a6e22e">nameOff</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">ptrToThis</span> <span style="color:#a6e22e">typeOff</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>Go</code>语言各种数据类型都是在 <code>_type</code> 字段的基础上，增加一些额外的字段来进行管理的。</p>
<p>非空<code>interface</code>的实现(src\runtime\runtime2.go line 192左右):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">iface</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">tab</span>  <span style="color:#f92672">*</span><span style="color:#a6e22e">itab</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">data</span> <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">itab</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">inter</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">interfacetype</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">_type</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">_type</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">hash</span>  <span style="color:#66d9ef">uint32</span>     <span style="color:#75715e">// copy of _type.hash. Used for type switches.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">_</span>     [<span style="color:#ae81ff">4</span>]<span style="color:#66d9ef">byte</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fun</span>   [<span style="color:#ae81ff">1</span>]<span style="color:#66d9ef">uintptr</span> <span style="color:#75715e">// variable sized. fun[0]==0 means _type does not implement inter.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><p>第一个<code>itab</code>中存放了类型信息，还有一个<code>fun</code>表示方法表。<code>fun</code> 数组的大小为 1，这里存储的是第一个方法的函数指针， 如果有更多的方法，在它之后的内存空间里继续存储。 从汇编角度来看，通过增加地址就能获取到这些函数指针，没什么影响。顺便提一句，这些方法是按照函数名称的字典序进行排列的。</p>
<p><code>interfacetype</code>类型，src\runtime\type.go line 390左右：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">interfacetype</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">typ</span>     <span style="color:#a6e22e">_type</span>       <span style="color:#75715e">// 包装了 _type 类型
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">pkgpath</span> <span style="color:#a6e22e">name</span>        <span style="color:#75715e">// 接口所定义的函数列表
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">mhdr</span>    []<span style="color:#a6e22e">imethod</span>   <span style="color:#75715e">// 记录定义了接口的包名
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><h2 id="interface的构造过程">Interface的构造过程<a href="#interface的构造过程" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>先来看看这个例子（方便观察加上了行号）：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#ae81ff">1</span> <span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">3</span> <span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">4</span>     <span style="color:#e6db74">&#34;strconv&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">5</span>     <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">6</span> )
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">7</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">8</span> <span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Stringer</span> <span style="color:#66d9ef">interface</span> {
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">9</span>     <span style="color:#a6e22e">String</span>() <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">10</span> }
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">11</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">12</span> <span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Binary</span> <span style="color:#66d9ef">uint64</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">13</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">14</span> <span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">i</span> <span style="color:#a6e22e">Binary</span>) <span style="color:#a6e22e">String</span>() <span style="color:#66d9ef">string</span> {
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">15</span>     <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">strconv</span>.<span style="color:#a6e22e">FormatUint</span>(<span style="color:#a6e22e">i</span>.<span style="color:#a6e22e">Get</span>(), <span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">16</span> }
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">17</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">18</span> <span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">i</span> <span style="color:#a6e22e">Binary</span>) <span style="color:#a6e22e">Get</span>() <span style="color:#66d9ef">uint64</span> {
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">19</span>     <span style="color:#66d9ef">return</span> uint64(<span style="color:#a6e22e">i</span>)
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">20</span> }
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">21</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">22</span> <span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">23</span>     <span style="color:#a6e22e">b</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">Binary</span>(<span style="color:#ae81ff">200</span>)
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">24</span>     <span style="color:#a6e22e">s</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">Stringer</span>(<span style="color:#a6e22e">b</span>)
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">25</span>     <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">String</span>())  <span style="color:#75715e">// 输出11001000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">26</span> }
</span></span></code></pre></div><p>执行命令： <code>go tool compile -S gotest.go &gt; main.txt</code></p>
<p>其中一段<code>main</code>函数的汇编代码如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;</span>.<span style="color:#a6e22e">main</span> <span style="color:#a6e22e">STEXT</span> <span style="color:#a6e22e">size</span>=<span style="color:#ae81ff">210</span> <span style="color:#a6e22e">args</span>=<span style="color:#ae81ff">0x0</span> <span style="color:#a6e22e">locals</span>=<span style="color:#ae81ff">0x58</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x0000</span> <span style="color:#ae81ff">00000</span> (<span style="color:#a6e22e">gotest</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">22</span>)	<span style="color:#a6e22e">TEXT</span>	<span style="color:#e6db74">&#34;&#34;</span>.<span style="color:#a6e22e">main</span>(<span style="color:#a6e22e">SB</span>), <span style="color:#a6e22e">ABIInternal</span>, <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">88</span><span style="color:#f92672">-</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x0000</span> <span style="color:#ae81ff">00000</span> (<span style="color:#a6e22e">gotest</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">22</span>)	<span style="color:#a6e22e">MOVQ</span>	<span style="color:#a6e22e">TLS</span>, <span style="color:#a6e22e">CX</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x0009</span> <span style="color:#ae81ff">0000</span><span style="color:#ae81ff">9</span> (<span style="color:#a6e22e">gotest</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">22</span>)	<span style="color:#a6e22e">MOVQ</span>	(<span style="color:#a6e22e">CX</span>)(<span style="color:#a6e22e">TLS</span><span style="color:#f92672">*</span><span style="color:#ae81ff">2</span>), <span style="color:#a6e22e">CX</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x0010</span> <span style="color:#ae81ff">00016</span> (<span style="color:#a6e22e">gotest</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">22</span>)	<span style="color:#a6e22e">CMPQ</span>	<span style="color:#a6e22e">SP</span>, <span style="color:#ae81ff">16</span>(<span style="color:#a6e22e">CX</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x0014</span> <span style="color:#ae81ff">00020</span> (<span style="color:#a6e22e">gotest</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">22</span>)	<span style="color:#a6e22e">JLS</span>	<span style="color:#ae81ff">200</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x001a</span> <span style="color:#ae81ff">00026</span> (<span style="color:#a6e22e">gotest</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">22</span>)	<span style="color:#a6e22e">SUBQ</span>	<span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">88</span>, <span style="color:#a6e22e">SP</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x001e</span> <span style="color:#ae81ff">00030</span> (<span style="color:#a6e22e">gotest</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">22</span>)	<span style="color:#a6e22e">MOVQ</span>	<span style="color:#a6e22e">BP</span>, <span style="color:#ae81ff">80</span>(<span style="color:#a6e22e">SP</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x0023</span> <span style="color:#ae81ff">00035</span> (<span style="color:#a6e22e">gotest</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">22</span>)	<span style="color:#a6e22e">LEAQ</span>	<span style="color:#ae81ff">80</span>(<span style="color:#a6e22e">SP</span>), <span style="color:#a6e22e">BP</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x0028</span> <span style="color:#ae81ff">00040</span> (<span style="color:#a6e22e">gotest</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">22</span>)	<span style="color:#a6e22e">FUNCDATA</span>	<span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">gclocals</span><span style="color:#960050;background-color:#1e0010">·</span><span style="color:#ae81ff">69</span><span style="color:#a6e22e">c1753bd5f81501d95132d08af04464</span>(<span style="color:#a6e22e">SB</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x0028</span> <span style="color:#ae81ff">00040</span> (<span style="color:#a6e22e">gotest</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">22</span>)	<span style="color:#a6e22e">FUNCDATA</span>	<span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">1</span>, <span style="color:#a6e22e">gclocals</span><span style="color:#960050;background-color:#1e0010">·</span><span style="color:#ae81ff">568470801006e5</span><span style="color:#a6e22e">c0dc3947ea998fe279</span>(<span style="color:#a6e22e">SB</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x0028</span> <span style="color:#ae81ff">00040</span> (<span style="color:#a6e22e">gotest</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">22</span>)	<span style="color:#a6e22e">FUNCDATA</span>	<span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">2</span>, <span style="color:#a6e22e">gclocals</span><span style="color:#960050;background-color:#1e0010">·</span><span style="color:#a6e22e">bfec7e55b3f043d1941c093912808913</span>(<span style="color:#a6e22e">SB</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x0028</span> <span style="color:#ae81ff">00040</span> (<span style="color:#a6e22e">gotest</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">22</span>)	<span style="color:#a6e22e">FUNCDATA</span>	<span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">3</span>, <span style="color:#e6db74">&#34;&#34;</span>.<span style="color:#a6e22e">main</span>.<span style="color:#a6e22e">stkobj</span>(<span style="color:#a6e22e">SB</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x0028</span> <span style="color:#ae81ff">00040</span> (<span style="color:#a6e22e">gotest</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">24</span>)	<span style="color:#a6e22e">PCDATA</span>	<span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">0</span>, <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x0028</span> <span style="color:#ae81ff">00040</span> (<span style="color:#a6e22e">gotest</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">24</span>)	<span style="color:#a6e22e">PCDATA</span>	<span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">1</span>, <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x0028</span> <span style="color:#ae81ff">00040</span> (<span style="color:#a6e22e">gotest</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">24</span>)	<span style="color:#a6e22e">MOVQ</span>	<span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">200</span>, (<span style="color:#a6e22e">SP</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x0030</span> <span style="color:#ae81ff">0004</span><span style="color:#ae81ff">8</span> (<span style="color:#a6e22e">gotest</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">24</span>)	<span style="color:#a6e22e">CALL</span>	<span style="color:#a6e22e">runtime</span>.<span style="color:#a6e22e">convT64</span>(<span style="color:#a6e22e">SB</span>)                      <span style="color:#75715e">// 首先将200转换为int64类型，这里会构造出一个inteface
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#ae81ff">0x0035</span> <span style="color:#ae81ff">00053</span> (<span style="color:#a6e22e">gotest</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">25</span>)	<span style="color:#a6e22e">PCDATA</span>	<span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">0</span>, <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x0035</span> <span style="color:#ae81ff">00053</span> (<span style="color:#a6e22e">gotest</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">25</span>)	<span style="color:#a6e22e">LEAQ</span>	<span style="color:#66d9ef">go</span>.<span style="color:#a6e22e">itab</span>.<span style="color:#e6db74">&#34;&#34;</span>.<span style="color:#a6e22e">Binary</span>,<span style="color:#e6db74">&#34;&#34;</span>.<span style="color:#a6e22e">Stringer</span>(<span style="color:#a6e22e">SB</span>), <span style="color:#a6e22e">AX</span>    <span style="color:#75715e">// 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#ae81ff">0x003c</span> <span style="color:#ae81ff">00060</span> (<span style="color:#a6e22e">gotest</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">25</span>)	<span style="color:#a6e22e">PCDATA</span>	<span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">0</span>, <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x003c</span> <span style="color:#ae81ff">00060</span> (<span style="color:#a6e22e">gotest</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">25</span>)	<span style="color:#a6e22e">TESTB</span>	<span style="color:#a6e22e">AL</span>, (<span style="color:#a6e22e">AX</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x003e</span> <span style="color:#ae81ff">00062</span> (<span style="color:#a6e22e">gotest</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">24</span>)	<span style="color:#a6e22e">PCDATA</span>	<span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">0</span>, <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x003e</span> <span style="color:#ae81ff">00062</span> (<span style="color:#a6e22e">gotest</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">24</span>)	<span style="color:#a6e22e">MOVQ</span>	<span style="color:#ae81ff">8</span>(<span style="color:#a6e22e">SP</span>), <span style="color:#a6e22e">AX</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x0043</span> <span style="color:#ae81ff">00067</span> (<span style="color:#a6e22e">gotest</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">25</span>)	<span style="color:#a6e22e">MOVQ</span>	<span style="color:#66d9ef">go</span>.<span style="color:#a6e22e">itab</span>.<span style="color:#e6db74">&#34;&#34;</span>.<span style="color:#a6e22e">Binary</span>,<span style="color:#e6db74">&#34;&#34;</span>.<span style="color:#a6e22e">Stringer</span><span style="color:#f92672">+</span><span style="color:#ae81ff">24</span>(<span style="color:#a6e22e">SB</span>), <span style="color:#a6e22e">CX</span> <span style="color:#75715e">// 将Stringer.String函数地址放进 CX
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#ae81ff">0x004a</span> <span style="color:#ae81ff">00074</span> (<span style="color:#a6e22e">gotest</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">25</span>)	<span style="color:#a6e22e">PCDATA</span>	<span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">0</span>, <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x004a</span> <span style="color:#ae81ff">00074</span> (<span style="color:#a6e22e">gotest</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">25</span>)	<span style="color:#a6e22e">MOVQ</span>	<span style="color:#a6e22e">AX</span>, (<span style="color:#a6e22e">SP</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x004e</span> <span style="color:#ae81ff">0007</span><span style="color:#ae81ff">8</span> (<span style="color:#a6e22e">gotest</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">25</span>)	<span style="color:#a6e22e">CALL</span>	<span style="color:#a6e22e">CX</span>                                       <span style="color:#75715e">// 调用Stringer.String
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#ae81ff">0x0050</span> <span style="color:#ae81ff">000</span><span style="color:#ae81ff">80</span> (<span style="color:#a6e22e">gotest</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">25</span>)	<span style="color:#a6e22e">PCDATA</span>	<span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">0</span>, <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x0050</span> <span style="color:#ae81ff">000</span><span style="color:#ae81ff">80</span> (<span style="color:#a6e22e">gotest</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">25</span>)	<span style="color:#a6e22e">MOVQ</span>	<span style="color:#ae81ff">8</span>(<span style="color:#a6e22e">SP</span>), <span style="color:#a6e22e">AX</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x0055</span> <span style="color:#ae81ff">000</span><span style="color:#ae81ff">85</span> (<span style="color:#a6e22e">gotest</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">25</span>)	<span style="color:#a6e22e">MOVQ</span>	<span style="color:#ae81ff">16</span>(<span style="color:#a6e22e">SP</span>), <span style="color:#a6e22e">CX</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x005a</span> <span style="color:#ae81ff">000</span><span style="color:#ae81ff">90</span> (<span style="color:#a6e22e">gotest</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">25</span>)	<span style="color:#a6e22e">PCDATA</span>	<span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">0</span>, <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x005a</span> <span style="color:#ae81ff">000</span><span style="color:#ae81ff">90</span> (<span style="color:#a6e22e">gotest</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">25</span>)	<span style="color:#a6e22e">MOVQ</span>	<span style="color:#a6e22e">AX</span>, (<span style="color:#a6e22e">SP</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x005e</span> <span style="color:#ae81ff">000</span><span style="color:#ae81ff">94</span> (<span style="color:#a6e22e">gotest</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">25</span>)	<span style="color:#a6e22e">MOVQ</span>	<span style="color:#a6e22e">CX</span>, <span style="color:#ae81ff">8</span>(<span style="color:#a6e22e">SP</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x0063</span> <span style="color:#ae81ff">000</span><span style="color:#ae81ff">99</span> (<span style="color:#a6e22e">gotest</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">25</span>)	<span style="color:#a6e22e">CALL</span>	<span style="color:#a6e22e">runtime</span>.<span style="color:#a6e22e">convTstring</span>(<span style="color:#a6e22e">SB</span>)                  <span style="color:#75715e">// 函数strconv.FormatUint内部的转换
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#ae81ff">0x0068</span> <span style="color:#ae81ff">00104</span> (<span style="color:#a6e22e">gotest</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">25</span>)	<span style="color:#a6e22e">PCDATA</span>	<span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">0</span>, <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x0068</span> <span style="color:#ae81ff">00104</span> (<span style="color:#a6e22e">gotest</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">25</span>)	<span style="color:#a6e22e">MOVQ</span>	<span style="color:#ae81ff">16</span>(<span style="color:#a6e22e">SP</span>), <span style="color:#a6e22e">AX</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x006d</span> <span style="color:#ae81ff">0010</span><span style="color:#ae81ff">9</span> (<span style="color:#a6e22e">gotest</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">25</span>)	<span style="color:#a6e22e">PCDATA</span>	<span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">1</span>, <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x006d</span> <span style="color:#ae81ff">0010</span><span style="color:#ae81ff">9</span> (<span style="color:#a6e22e">gotest</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">25</span>)	<span style="color:#a6e22e">XORPS</span>	<span style="color:#a6e22e">X0</span>, <span style="color:#a6e22e">X0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x0070</span> <span style="color:#ae81ff">00112</span> (<span style="color:#a6e22e">gotest</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">25</span>)	<span style="color:#a6e22e">MOVUPS</span>	<span style="color:#a6e22e">X0</span>, <span style="color:#e6db74">&#34;&#34;</span>..<span style="color:#a6e22e">autotmp_16</span><span style="color:#f92672">+</span><span style="color:#ae81ff">64</span>(<span style="color:#a6e22e">SP</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x0075</span> <span style="color:#ae81ff">00117</span> (<span style="color:#a6e22e">gotest</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">25</span>)	<span style="color:#a6e22e">PCDATA</span>	<span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">0</span>, <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x0075</span> <span style="color:#ae81ff">00117</span> (<span style="color:#a6e22e">gotest</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">25</span>)	<span style="color:#a6e22e">LEAQ</span>	<span style="color:#66d9ef">type</span>.string(<span style="color:#a6e22e">SB</span>), <span style="color:#a6e22e">CX</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x007c</span> <span style="color:#ae81ff">00124</span> (<span style="color:#a6e22e">gotest</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">25</span>)	<span style="color:#a6e22e">PCDATA</span>	<span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">0</span>, <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x007c</span> <span style="color:#ae81ff">00124</span> (<span style="color:#a6e22e">gotest</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">25</span>)	<span style="color:#a6e22e">MOVQ</span>	<span style="color:#a6e22e">CX</span>, <span style="color:#e6db74">&#34;&#34;</span>..<span style="color:#a6e22e">autotmp_16</span><span style="color:#f92672">+</span><span style="color:#ae81ff">64</span>(<span style="color:#a6e22e">SP</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x0081</span> <span style="color:#ae81ff">0012</span><span style="color:#ae81ff">9</span> (<span style="color:#a6e22e">gotest</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">25</span>)	<span style="color:#a6e22e">PCDATA</span>	<span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">0</span>, <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x0081</span> <span style="color:#ae81ff">0012</span><span style="color:#ae81ff">9</span> (<span style="color:#a6e22e">gotest</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">25</span>)	<span style="color:#a6e22e">MOVQ</span>	<span style="color:#a6e22e">AX</span>, <span style="color:#e6db74">&#34;&#34;</span>..<span style="color:#a6e22e">autotmp_16</span><span style="color:#f92672">+</span><span style="color:#ae81ff">72</span>(<span style="color:#a6e22e">SP</span>)
</span></span></code></pre></div><p>查看<code>go.itab.””.Binary,””.Stringer(SB)</code>这个地方：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#66d9ef">go</span>.<span style="color:#a6e22e">itab</span>.<span style="color:#e6db74">&#34;&#34;</span>.<span style="color:#a6e22e">Binary</span>,<span style="color:#e6db74">&#34;&#34;</span>.<span style="color:#a6e22e">Stringer</span> <span style="color:#a6e22e">SRODATA</span> <span style="color:#a6e22e">dupok</span> <span style="color:#a6e22e">size</span>=<span style="color:#ae81ff">32</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x0000</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  <span style="color:#f92672">...............</span>.
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x0010</span> <span style="color:#ae81ff">3</span><span style="color:#a6e22e">b</span> <span style="color:#ae81ff">3</span><span style="color:#a6e22e">d</span> <span style="color:#ae81ff">72</span> <span style="color:#ae81ff">44</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  ;=<span style="color:#a6e22e">rD</span><span style="color:#f92672">............</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">rel</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">+</span><span style="color:#ae81ff">8</span> <span style="color:#a6e22e">t</span>=<span style="color:#ae81ff">1</span> <span style="color:#66d9ef">type</span>.<span style="color:#e6db74">&#34;&#34;</span>.<span style="color:#a6e22e">Stringer</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">rel</span> <span style="color:#ae81ff">8</span><span style="color:#f92672">+</span><span style="color:#ae81ff">8</span> <span style="color:#a6e22e">t</span>=<span style="color:#ae81ff">1</span> <span style="color:#66d9ef">type</span>.<span style="color:#e6db74">&#34;&#34;</span>.<span style="color:#a6e22e">Binary</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">rel</span> <span style="color:#ae81ff">24</span><span style="color:#f92672">+</span><span style="color:#ae81ff">8</span> <span style="color:#a6e22e">t</span>=<span style="color:#ae81ff">1</span> <span style="color:#e6db74">&#34;&#34;</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">Binary</span>).<span style="color:#a6e22e">String</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0</span>
</span></span></code></pre></div><p><code>size</code>大小为32<code>Byte</code>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">itab</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">inter</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">interfacetype</span>  <span style="color:#75715e">// 8 Byte (64位机子，指针)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">_type</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">_type</span>          <span style="color:#75715e">// 8 Byte (64位机子，指针)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">hash</span>  <span style="color:#66d9ef">uint32</span>          <span style="color:#75715e">// 4 Byte
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">_</span>     [<span style="color:#ae81ff">4</span>]<span style="color:#66d9ef">byte</span>         <span style="color:#75715e">// 4 Byte
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">fun</span>   [<span style="color:#ae81ff">1</span>]<span style="color:#66d9ef">uintptr</span>      <span style="color:#75715e">// 8 Byte
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><p>每个字段相加，就是<code>itab</code>结构体的大小32字节，那串数字是<code>itab</code>序列化后的内容，可以对应找出<code>hash</code>值，在判断两个类型是否相同的时候会用这个值比较。</p>
<p>对于<code>Binary</code>，作为一个64位整数，可以这么表示:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">b</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">Binary</span>(<span style="color:#ae81ff">200</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">+==========+</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">|</span>   <span style="color:#ae81ff">200</span>              <span style="color:#f92672">|</span> 
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">+==========+</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">int64</span>
</span></span></code></pre></div><p>对于<code>s := Stringer(b)</code>，可以如下表示：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>s :<span style="color:#f92672">=</span> Stringer<span style="color:#f92672">(</span>b<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>+<span style="color:#f92672">========</span>+           itab
</span></span><span style="display:flex;"><span>| tab    | ----&gt;  +<span style="color:#f92672">=======</span>+
</span></span><span style="display:flex;"><span>+<span style="color:#f92672">========</span>+        | inter | 
</span></span><span style="display:flex;"><span>| data   |---&gt;200 +<span style="color:#f92672">=======</span>+
</span></span><span style="display:flex;"><span>+<span style="color:#f92672">========</span>+        |  type | ---&gt; Stringer.Binary
</span></span><span style="display:flex;"><span>                                 +<span style="color:#f92672">=======</span>+
</span></span><span style="display:flex;"><span>                                 | hash  |
</span></span><span style="display:flex;"><span>                                 +<span style="color:#f92672">=======</span>+
</span></span><span style="display:flex;"><span>                                 |  fun  | ---&gt; *Binary.String
</span></span><span style="display:flex;"><span>                                 +<span style="color:#f92672">=======</span>+
</span></span></code></pre></div><p>那么对于<code>s</code>来说 <code>itab</code>中的<code>inter</code>表示的是<code>Stringer</code>这个接口，<code>type</code>表示的是<code>Binary</code>这个动态类型，<code>fun</code>函数表中存放的就是<code>Binary</code>中实现了<code>String</code>而接口的方法地址。</p>
<p>对于接口的<code>type-switch</code>，返回的就是静态类型 对于反射里面的<code>TypeOf</code>，返回的是动态类型，也就是数据真实的类型</p>
<p>对于调用<code>s.String()</code>方法，其实就是 <code>s.itab-&gt;fun[0]</code>。</p>
<p>这里就引出一个需要注意的地方：，<code>var a interface{}</code> 这个地方用<code>if a == nil</code>是可以判断的， 但是如果使用其他类型的<code>nil</code>指针赋给<code>interface</code>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">b</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Binary</span> = <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">a</span> <span style="color:#66d9ef">interface</span>{} = <span style="color:#a6e22e">b</span>
</span></span></code></pre></div><p>这时候<code>if a == nil</code>就不会成立的，即使<code>b</code>为<code>nil</code>，这是因为这个时候<code>a</code>的结构如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>   a
</span></span><span style="display:flex;"><span><span style="color:#f92672">+========</span>+               itab
</span></span><span style="display:flex;"><span>| tab    | -------&gt;   +<span style="color:#f92672">========</span>+
</span></span><span style="display:flex;"><span>+<span style="color:#f92672">========</span>+            |inter   | 
</span></span><span style="display:flex;"><span>| data   | ---&gt; nil   <span style="color:#f92672">+========</span>+
</span></span><span style="display:flex;"><span>+<span style="color:#f92672">========</span>+            | type   |
</span></span><span style="display:flex;"><span>                      +<span style="color:#f92672">========</span>+
</span></span><span style="display:flex;"><span>                      |   ...  |
</span></span></code></pre></div><p>所以这个时候你把一个其他类型的<code>nil</code>指针赋值给<code>interface{}</code>的时候，<code>interface</code>并不是空，而是对<code>interface</code>进行了初始化，只不过<code>data</code>是<code>nil</code>而已。所有如果一个参数的返回值是<code>interface{}</code>或者其他有方法的<code>interface</code>，比如<code>error</code>等，所以一旦函数返回的是某种<code>interface</code>的时候，就需要注意，不要直接返回某种类型的空指针，需要转换成直接的<code>nil</code>进行赋值。如：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">doSomething</span>() (<span style="color:#66d9ef">interface</span>{}) {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">a</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Binary</span> = <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//do something
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">a</span>  <span style="color:#75715e">// 这边应该判断a是nil然后直接返回nil
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><h2 id="总结">总结<a href="#总结" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>本片笔记主要记录一些<code>interface</code>的原理，若有什么不对的地方欢迎指正。 <code>iface</code>与<code>eface</code>的区别以及<code>convT2I</code>、<code>convT2E</code>函数的源码也没深入去了解，希望以后有时间可以看一看。</p>
<p><em><strong>参考：</strong></em></p>
<p><a href="https://www.cnblogs.com/qcrao-2018/p/10766091.html">深度解密Go语言之关于 interface 的10个问题</a></p>
<p><a href="http://shanks.leanote.com/post/interface%E8%AF%A6%E8%A7%A3">深度剖析interface </a></p>

      </div></div>

  
  
<div class="pagination">
    <div class="pagination__title">
        <span class="pagination__title-h">Read other posts</span>
        <hr />
    </div>
    <div class="pagination__buttons">
        
        <span class="button previous">
            <a href="http://hindung.cn/posts/2/">
                <span class="button__icon">←</span>
                <span class="button__text">Docker镜像优化</span>
            </a>
        </span>
        
        
        <span class="button next">
            <a href="http://hindung.cn/posts/0/">
                <span class="button__text">部落格修改记录</span>
                <span class="button__icon">→</span>
            </a>
        </span>
        
    </div>
</div>

  

  
  

  
</div>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span>© 2022 Powered by <a href="http://gohugo.io">Hugo</a></span>
    
        <span>:: Theme made by <a href="https://twitter.com/panr">panr</a></span>
      </div>
  </div>
</footer>

<script src="http://hindung.cn/assets/main.js"></script>
<script src="http://hindung.cn/assets/prism.js"></script>


  <script src="http://hindung.cn/assets/languageSelector.js"></script>






  
</div>

</body>
</html>
